#!/bin/bash
# =====================================================
# LXC-Erstellung: Portainer + Docker
# Debian 12, Unprivileged, nesting, fuse, keyctl, statische IP
# =====================================================
set -e

# ------------------------
# Variablen
# ------------------------
HOSTNAME=port-netzwerk
TEMPLATE="/backup/template/cache/debian-12-standard_12.12-1_amd64.tar.zst"
STORAGE="local-zfs"
DISK_SIZE="16"
MEMORY=4096
CORES=2
GATEWAY="192.168.178.1"
NETMASK="24"
ROOT_PASS="11111"
CTID_START=150
CTID_END=200
# ------------------------
# Nächste freie CTID ermitteln (150-200)
# ------------------------
for i in $(seq $CTID_START $CTID_END); do
  if ! pvesh get /cluster/resources --type vm | grep -qE "(qemu|lxc)/$i"; then
    CTID=$i
    break
  fi
done

if [ -z "$CTID" ]; then
  echo "Fehler: Keine freie CTID gefunden!"
  exit 1
fi

IP="192.168.178.$CTID"
echo "==> Nächste freie CTID: $CTID"
echo "==> Statische IP: $IP"

# ------------------------
# LXC erstellen
# ------------------------
pct create $CTID $TEMPLATE \
  --hostname $HOSTNAME \
  --cores $CORES \
  --memory $MEMORY \
  --swap 0 \
  --rootfs $STORAGE:$DISK_SIZE \
  --net0 name=eth0,bridge=vmbr0,ip=$IP/$NETMASK,gw=$GATEWAY,type=veth \
  --unprivileged 1 \
  --features nesting=1,fuse=1,keyctl=1

# ------------------------
# LXC starten und Root-Passwort setzen
# ------------------------
pct start $CTID
pct exec $CTID -- bash -c "echo 'root:$ROOT_PASS' | chpasswd"

# ------------------------
# Grundsystem vorbereiten
# ------------------------
pct exec $CTID -- apt update -y && apt upgrade -y
pct exec $CTID -- apt install -y wget curl gnupg2 lsb-release sudo

# ------------------------
# Docker installieren
# ------------------------
pct exec $CTID -- bash -c "curl -fsSL https://get.docker.com -o get-docker.sh"
pct exec $CTID -- bash -c "sh get-docker.sh"
pct exec $CTID -- systemctl enable --now docker
pct exec $CTID -- usermod -aG docker $USER  # Optional: Benutzer zur Docker-Gruppe hinzufügen


# ------------------------
# Portainer installieren
# ------------------------
pct exec $CTID -- bash -c "docker volume create portainer_agent"
pct exec $CTID -- bash -c "docker run -d -p 9001:9001 --name portainer_agent --restart always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v portainer_agent:/data portainer/agent:latest"

echo "-----------------------------------------------------"
echo "LXC $CTID erstellt und gestartet mit IP: $IP"
echo "Coral USB Device $DEVICE_PATH in /etc/pve/lxc/$CTID.conf eingetragen"
echo " /dev/dri/renderD129"
echo "Root-Passwort: $ROOT_PASS"
echo "Portainer: https://$IP:9443"
echo "-----------------------------------------------------"
