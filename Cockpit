#!/bin/bash
# =====================================================
# LXC-Erstellung: Cockpit + Samba
# Debian 13, Privileged, nesting statische IP
# Host-ZFS als Bind-Mount
# =====================================================
set -e

# ------------------------
# Variablen
# ------------------------
HOSTNAME=smb
TEMPLATE="local:vztmpl/debian-13-standard_13.1-2_amd64.tar.zst"
STORAGE="vm"
DISK_SIZE="1"
MEMORY=512 #8192 #16384 #24576
CORES=1
SAMBA_MOUNT="hdd"
ZPOOL_PATH="/mnt/hdd"
ZPOOL_MOUNT="/mnt/hdd"
GATEWAY="192.168.178.1"
NETMASK="24"
ROOT_PASS="11111"
ADMIN_USER="admin"
ADMIN_PASS="11111"

# ------------------------
# Nächste freie CTID ermitteln (150-200)
# ------------------------
for i in $(seq 150 200); do
  if ! pvesh get /cluster/resources --type vm | grep -qE "(qemu|lxc)/$i"; then
    CTID=$i
    break
  fi
done

if [ -z "$CTID" ]; then
  echo "Fehler: Keine freie CTID gefunden!"
  exit 1
fi

IP="192.168.178.$CTID"
echo "==> Nächste freie CTID: $CTID"
echo "==> Statische IP: $IP"

# ------------------------
# LXC erstellen
# ------------------------
pct create $CTID $TEMPLATE \
  --hostname $HOSTNAME \
  --cores $CORES \
  --memory $MEMORY \
  --swap 0 \
  --rootfs $STORAGE:$DISK_SIZE \
  --net0 name=eth0,bridge=vmbr0,firewall=1,ip=$IP/$NETMASK,gw=$GATEWAY,type=veth \
  --unprivileged 0 \
  --features nesting=1


# ZFS-Pool als Mount einhängen
pct set $CTID -mp0 $ZPOOL_PATH,mp=$ZPOOL_MOUNT

# ------------------------
# Container starten
# ------------------------
pct start $CTID

# ------------------------
# Root-Passwort setzen
# ------------------------
pct exec $CTID -- bash -c "echo 'root:$ROOT_PASS' | chpasswd"

# ------------------------
# Grundsystem vorbereiten
# ------------------------
pct exec $CTID -- apt clean
pct exec $CTID -- rm -rf /var/lib/apt/lists/*
pct exec $CTID -- bash -c "apt update -y && apt upgrade -y"
pct exec $CTID -- apt install -y wget curl gnupg2 lsb-release sudo

# ------------------------
# Cockpit installieren
# ------------------------

pct exec $CTID -- bash -c "wget -qO- https://repo.45drives.com/key/gpg.asc | gpg --dearmor | tee /usr/share/keyrings/45drives-archive-keyring.gpg >/dev/null"
pct exec $CTID -- bash -c "echo 'deb [signed-by=/usr/share/keyrings/45drives-archive-keyring.gpg] https://repo.45drives.com/enterprise/debian bookworm main' > /etc/apt/sources.list.d/45drives-enterprise.list"
pct exec $CTID -- apt update -y

pct exec $CTID -- apt install -y cockpit samba wsdd2
pct exec $CTID -- apt install -y cockpit-packagekit cockpit-storaged #cockpit-networkmanager 
pct exec $CTID -- apt install -y cockpit-navigator cockpit-identities cockpit-file-sharing
pct exec $CTID -- systemctl enable --now cockpit.socket

# ------------------------
# Admin-User mit sudo anlegen
# ------------------------
pct exec $CTID -- bash -c "adduser --gecos '' --disabled-password $ADMIN_USER"
pct exec $CTID -- bash -c "echo '$ADMIN_USER:$ADMIN_PASS' | chpasswd"
pct exec $CTID -- usermod -aG sudo $ADMIN_USER

# ------------------------
# Cockpit Socket prüfen
# ------------------------
pct exec $CTID -- systemctl status cockpit.socket | head -n 10

# ------------------------
# Fertig
# ------------------------
echo "-----------------------------------------------------"
echo "Container $CTID erstellt und gestartet mit IP: $IP"
echo "Root-Passwort: $ROOT_PASS"
echo "Admin-User für Cockpit: $ADMIN_USER | Passwort: $ADMIN_PASS"
echo "Cockpit: https://$IP:9090"
echo "Samba-Share: \\\\$IP\\$SAMBA_MOUNT"
echo "-----------------------------------------------------"
